<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="v2rayWinUI.Views.ProfilesView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:behaviors="using:CommunityToolkit.WinUI.Behaviors"
    xmlns:cwc="using:CommunityToolkit.WinUI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:local="using:v2rayWinUI.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:ServiceLib.Models"
    x:Name="ThisPage"
    mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Top Bar (match v2rayN layout)  -->
        <Border
            Grid.Row="0"
            Padding="8"
            Background="{ThemeResource LayerFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="0,0,0,1">
            <Grid ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!--  Subscription groups  -->
                <StackPanel
                    Grid.Column="0"
                    Orientation="Horizontal"
                    Spacing="8">
                    <ToggleButton
                        x:Name="chipAll"
                        x:Uid="Profiles_Subscription_All"
                        Content="所有"
                        IsChecked="True" />
                    <ItemsRepeater x:Name="repSubGroups" Margin="8,0,0,0">
                        <ItemsRepeater.Layout>
                            <StackLayout Orientation="Horizontal" Spacing="8" />
                        </ItemsRepeater.Layout>
                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate x:DataType="models:SubItem">
                                <ToggleButton
                                    Content="{x:Bind Remarks, Mode=OneWay}"
                                    Tag="{x:Bind Id, Mode=OneWay}" />
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>
                </StackPanel>

                <!--  Icons group: edit/add like original  -->
                <StackPanel
                    Grid.Column="1"
                    Orientation="Horizontal"
                    Spacing="6">
                    <Button
                        x:Name="btnEditServer"
                        Style="{StaticResource DefButton}"
                        IsEnabled="False"
                        ToolTipService.ToolTip="Edit">
                        <FontIcon Glyph="&#xE70F;" />
                    </Button>
                    <Button
                        x:Name="btnAddServer"
                        Style="{StaticResource DefButton}"
                        ToolTipService.ToolTip="Add">
                        <FontIcon Glyph="&#xE710;" />
                    </Button>
                    <Button
                        x:Name="btnRemoveServer"
                        Style="{StaticResource DefButton}"
                        ToolTipService.ToolTip="Remove">
                        <FontIcon Glyph="&#xE74D;" />
                    </Button>
                </StackPanel>

                <!--  Filter  -->
                <TextBox
                    x:Name="txtServerFilter"
                    x:Uid="Profiles_Filter"
                    Grid.Column="4"
                    Width="320"
                    HorizontalAlignment="Left"
                    PlaceholderText="过滤器；按回车执行"
                    Style="{StaticResource DefTextBox}">
                    <TextBox.Resources>
                        <SolidColorBrush x:Key="TextControlBackground" Color="Transparent" />
                    </TextBox.Resources>
                </TextBox>

                <!--  Quick actions (ping/speed icons)  -->
                <StackPanel
                    Grid.Column="5"
                    Orientation="Horizontal"
                    Spacing="6">
                    <Button
                        x:Name="btnTestSpeed"
                        Style="{StaticResource DefButton}"
                        ToolTipService.ToolTip="Test">
                        <FontIcon Glyph="&#xE9F9;" />
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!--  Server List  -->
        <ListView
            x:Name="lstServers"
            Grid.Row="1"
            Padding="0"
            SelectionMode="Extended">

            <ListView.Header>
                <Border
                    Padding="12,8"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="0,0,0,1">
                    <interactivity:Interaction.Behaviors>
                        <behaviors:StickyHeaderBehavior />
                    </interactivity:Interaction.Behaviors>

                    <cwc:DataTable ColumnSpacing="12">
                        <cwc:DataColumn Content="#" />
                        <cwc:DataColumn Content="类型" />
                        <cwc:DataColumn CanResize="True" Content="别名" />
                        <cwc:DataColumn CanResize="True" Content="地址" />
                        <cwc:DataColumn Content="端口" />
                        <cwc:DataColumn Content="传输协议" />
                        <cwc:DataColumn Content="TLS" />
                        <cwc:DataColumn Content="订阅分组" />
                        <cwc:DataColumn Content="延迟 (ms)" />
                        <cwc:DataColumn Content="速度 (MB/s)" />
                        <cwc:DataColumn Content="今日上传" />
                        <cwc:DataColumn Content="今日下载" />
                        <cwc:DataColumn Content="总上传" />
                        <cwc:DataColumn Content="总下载" />
                    </cwc:DataTable>
                </Border>
            </ListView.Header>

            <ListView.ItemTemplate>
                <DataTemplate x:DataType="models:ProfileItemModel">
                    <cwc:DataRow Margin="12,6" HorizontalAlignment="Left">
                        <TextBlock VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="{x:Bind Sort, Mode=OneWay}" />
                        <TextBlock VerticalAlignment="Center" Text="{x:Bind ConfigType, Mode=OneWay}" TextTrimming="CharacterEllipsis" />
                        <TextBlock VerticalAlignment="Center" Text="{x:Bind Remarks, Mode=OneWay}" TextTrimming="CharacterEllipsis" />
                        <TextBlock VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="{x:Bind Address, Mode=OneWay}" TextTrimming="CharacterEllipsis" />
                        <TextBlock VerticalAlignment="Center" Text="{x:Bind Port, Mode=OneWay}" />
                        <TextBlock VerticalAlignment="Center" Text="{x:Bind Network, Mode=OneWay}" TextTrimming="CharacterEllipsis" />
                        <TextBlock VerticalAlignment="Center" Text="{x:Bind StreamSecurity, Mode=OneWay}" TextTrimming="CharacterEllipsis" />
                        <TextBlock VerticalAlignment="Center" Text="{x:Bind SubRemarks, Mode=OneWay}" TextTrimming="CharacterEllipsis" />
                        <TextBlock VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="{x:Bind DelayVal, Mode=OneWay}" />
                        <TextBlock VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="{x:Bind SpeedVal, Mode=OneWay}" />
                        <TextBlock VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="{x:Bind TodayUp, Mode=OneWay}" />
                        <TextBlock VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="{x:Bind TodayDown, Mode=OneWay}" />
                        <TextBlock VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="{x:Bind TotalUp, Mode=OneWay}" />
                        <TextBlock VerticalAlignment="Center" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Text="{x:Bind TotalDown, Mode=OneWay}" />
                    </cwc:DataRow>
                </DataTemplate>
            </ListView.ItemTemplate>

            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="Padding" Value="0" />
                </Style>
            </ListView.ItemContainerStyle>

            <ListView.ContextFlyout>
                <MenuFlyout>
                    <MenuFlyoutItem x:Name="menuEdit" Text="Edit Server">
                        <MenuFlyoutItem.IsEnabled>
                            False
                        </MenuFlyoutItem.IsEnabled>
                        <MenuFlyoutItem.Icon>
                            <FontIcon Glyph="&#xE70F;" />
                        </MenuFlyoutItem.Icon>
                    </MenuFlyoutItem>
                    <MenuFlyoutItem x:Name="menuRemove" Text="Remove Server">
                        <MenuFlyoutItem.Icon>
                            <FontIcon Glyph="&#xE74D;" />
                        </MenuFlyoutItem.Icon>
                    </MenuFlyoutItem>
                    <MenuFlyoutSeparator />
                    <MenuFlyoutItem x:Name="menuSetDefault" Text="Set as Active">
                        <MenuFlyoutItem.Icon>
                            <FontIcon Glyph="&#xE73E;" />
                        </MenuFlyoutItem.Icon>
                    </MenuFlyoutItem>
                    <MenuFlyoutSeparator />
                    <MenuFlyoutSubItem Text="Test Speed">
                        <MenuFlyoutSubItem.Icon>
                            <FontIcon Glyph="&#xE9F9;" />
                        </MenuFlyoutSubItem.Icon>
                        <MenuFlyoutItem x:Name="menuMixedTest" Text="Mixed Test" />
                        <MenuFlyoutItem x:Name="menuTcping" Text="TCP Ping" />
                        <MenuFlyoutItem x:Name="menuRealPing" Text="Real Ping" />
                        <MenuFlyoutItem x:Name="menuSpeedTest" Text="Speed Test" />
                    </MenuFlyoutSubItem>
                    <MenuFlyoutSeparator />
                    <MenuFlyoutSubItem Text="Export">
                        <MenuFlyoutSubItem.Icon>
                            <FontIcon Glyph="&#xE74E;" />
                        </MenuFlyoutSubItem.Icon>
                        <MenuFlyoutItem x:Name="menuExportUrl" Text="Share URL" />
                        <MenuFlyoutItem x:Name="menuExportClipboard" Text="Copy to Clipboard" />
                    </MenuFlyoutSubItem>
                    <MenuFlyoutSeparator />
                    <MenuFlyoutSubItem Text="Move">
                        <MenuFlyoutSubItem.Icon>
                            <FontIcon Glyph="&#xE8DE;" />
                        </MenuFlyoutSubItem.Icon>
                        <MenuFlyoutItem x:Name="menuMoveTop" Text="Move to Top" />
                        <MenuFlyoutItem x:Name="menuMoveUp" Text="Move Up" />
                        <MenuFlyoutItem x:Name="menuMoveDown" Text="Move Down" />
                        <MenuFlyoutItem x:Name="menuMoveBottom" Text="Move to Bottom" />
                    </MenuFlyoutSubItem>
                </MenuFlyout>
            </ListView.ContextFlyout>
        </ListView>
    </Grid>
</Page>
